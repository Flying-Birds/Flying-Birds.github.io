<!-- Contact -->
{% if site.locale and site.locale != "" and site.locale != nil %}
<section class="page-section" id="{{ site.data.sitetext[site.locale].contact.section | default: 'contact' }}">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <h2 class="section-heading text-uppercase">
          {{ site.data.sitetext[site.locale].contact.title | markdownify | default: 'Contact Us' }}</h2>
        <h3 class="section-subheading text-muted">{{ site.data.sitetext[site.locale].contact.text | default: '' }}</h3>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <form id="contactForm" novalidate="novalidate">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <input name="name" class="form-control" id="name" type="text"
                  placeholder="{{ site.data.sitetext[site.locale].contact.name | default: 'Name*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.name-validation | default: 'Please enter your name.' }}">
                <p class="help-block text-danger"></p>
              </div>
              <div class="form-group d-none">
                <input name="username" class="form-control" id="username" type="text" tabindex="-1" autocomplete="off">
              </div>
              <div class="form-group">
                <input name="email" class="form-control" id="email" type="email"
                  placeholder="{{ site.data.sitetext[site.locale].contact.email | default: 'Email*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.email-validation | default: 'Please enter your email address.' }}">
                <p class="help-block text-danger"></p>
              </div>
              <div class="form-group">
                <input name="phone" class="form-control" id="phone" type="tel"
                  placeholder="{{ site.data.sitetext[site.locale].contact.phone | default: 'Phone Number*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.phone-validation | default: 'Please enter your phone number.' }}">
                <p class="help-block text-danger"></p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <textarea name="message" class="form-control" id="message"
                  placeholder="{{ site.data.sitetext[site.locale].contact.message | default: 'Message*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.message-validation | default: 'Please enter a message.' }}"></textarea>
                <p class="help-block text-danger"></p>
              </div>
            </div>
            <div class="clearfix"></div>
            <div class="col-lg-12 text-center">
              <div id="errorMessage" class="text-danger mb-3" style="min-height: 24px;"></div>
              <div id="success"></div>
              <button id="sendMessageButton" class="btn btn-primary btn-xl text-uppercase"
                type="submit">{{ site.data.sitetext[site.locale].contact.submit | default: 'Send Message' }}</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% else %}
<!-- 其他语言版本的 Contact -->
<section class="page-section" id="{{ site.data.sitetext[site.locale].contact.section | default: 'contact' }}">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <h2 class="section-heading text-uppercase">
          {{ site.data.sitetext[site.locale].contact.title | markdownify | default: '联系我们' }}</h2>
        <h3 class="section-subheading text-muted">{{ site.data.sitetext[site.locale].contact.text | default: '' }}</h3>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <form id="contactForm" novalidate="novalidate">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <input name="name" class="form-control" id="name" type="text"
                  placeholder="{{ site.data.sitetext[site.locale].contact.name | default: '姓名*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.name-validation | default: '请输入您的姓名。' }}">
                <p class="help-block text-danger"></p>
              </div>
              <div class="form-group d-none">
                <input name="username" class="form-control" id="username" type="text" tabindex="-1" autocomplete="off">
              </div>
              <div class="form-group">
                <input name="email" class="form-control" id="email" type="email"
                  placeholder="{{ site.data.sitetext[site.locale].contact.email | default: '邮箱*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.email-validation | default: '请输入您的邮箱地址。' }}">
                <p class="help-block text-danger"></p>
              </div>
              <div class="form-group">
                <input name="phone" class="form-control" id="phone" type="tel"
                  placeholder="{{ site.data.sitetext[site.locale].contact.phone | default: '电话号码*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.phone-validation | default: '请输入您的电话号码。' }}">
                <p class="help-block text-danger"></p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <textarea name="message" class="form-control" id="message"
                  placeholder="{{ site.data.sitetext[site.locale].contact.message | default: '留言*' }}"
                  required="required" data-validation-required-message="{{ site.data.sitetext[site.locale].contact.message-validation | default: '请输入留言内容。' }}"></textarea>
                <p class="help-block text-danger"></p>
              </div>
            </div>
            <div class="clearfix"></div>
            <div class="col-lg-12 text-center">
              <div id="errorMessage" class="text-danger mb-3" style="min-height: 24px;"></div>
              <div id="success"></div>
              <button id="sendMessageButton" class="btn btn-primary btn-xl text-uppercase"
                type="submit">{{ site.data.sitetext[site.locale].contact.submit | default: '发送留言' }}</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 移除所有可能的Formspree绑定
        if (window.jQuery) {
            const $ = window.jQuery;
            $('#contactForm').off('submit');
            if ($.fn.validate) {
                $('#contactForm').validate({ submitHandler: () => {} });
            }
        }

        const contactForm = document.getElementById('contactForm');
        if (!contactForm) return;

        contactForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const errorDiv = document.getElementById('errorMessage');
            if (!errorDiv) return;
            errorDiv.textContent = '';
            
            try {
                const data = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    message: document.getElementById('message').value
                };

                // 从环境变量获取令牌（关键：代码中不直接写令牌）
                const minToken = '{{ site.env.CONTACT_FORM_TOKEN }}';

                const response = await fetch('https://api.github.com/repos/Flying-Birds/Flying-Birds.github.io/issues', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'GitHub Pages Contact Form',
                        'Authorization': `token ${minToken}`
                    },
                    body: JSON.stringify({
                        title: `Contact from ${data.name}`,
                        body: `Name: ${data.name}\nEmail: ${data.email}\nPhone: ${data.phone}\nMessage: ${data.message}`
                    })
                });

                const responseText = await response.text();
                if (response.ok) {
                    document.getElementById('success').textContent = '消息发送成功！';
                    this.reset();
                    setTimeout(() => document.getElementById('success').textContent = '', 3000);
                } else {
                    errorDiv.textContent = `发送失败: ${response.status} - ${responseText.substring(0, 100)}`;
                }
            } catch (error) {
                errorDiv.textContent = `错误: ${error.message}`;
            }
        });
    });
</script>
